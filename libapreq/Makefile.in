#
# Top-level Makefile for APREQ
#
CPP = @CPP@

# gets substituted into some targets
APREQ_MAJOR_VERSION=@APREQ_MAJOR_VERSION@
APREQ_MINOR_VERSION=@APREQ_MINOR_VERSION@
APREQ_PATCH_VERSION=@APREQ_PATCH_VERSION@
APREQ_DOTTED_VERSION=@APREQ_DOTTED_VERSION@
APREQ_LIBTOOL_VERSION=@APREQ_LIBTOOL_VERSION@

srcdir = @srcdir@
VPATH = @srcdir@

INCLUDES = @APREQ_INCLUDES@ @APREQ_PRIV_INCLUDES@ @APR_INCLUDES@
APREQ_LDFLAGS = @APREQ_LDFLAGS@
APREQ_LIBS = @APREQ_LIBS@

TARGET_LIB = lib@APREQ_LIBNAME@.la
INSTALL_SUBDIRS =
EXTRA_SOURCE_DIRS =
APRUTIL_PCFILE = apr-util-$(APRUTIL_MAJOR_VERSION).pc
APREQ_CONFIG = apreq2-config
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@

TARGETS = $(TARGET_LIB) apreq.exp

# bring in rules.mk for standard functionality
@INCLUDE_RULES@
@INCLUDE_OUTPUTS@

LINK = $(LIBTOOL) $(LTFLAGS) --mode=link $(LT_LDFLAGS) $(COMPILE) -version-info $(APREQ_LIBTOOL_VERSION) $(ALL_LDFLAGS) -o $@

CLEAN_SUBDIRS = test

CLEAN_TARGETS = exports.c export_vars.c apreq.exp .make.dirs apreq2-config.out
DISTCLEAN_TARGETS = config.cache config.log config.status libtool \
	export_vars.sh $(APREQ_CONFIG) build/rules.mk \
	apr-util.pc build/pkg/pkginfo
EXTRACLEAN_TARGETS = configure aclocal.m4 \
	exports.c build-outputs.mk \
	build/apr_common.m4 build/find_apr.m4 build/install.sh \
	build/config.guess build/config.sub

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
includedir=@includedir@
top_srcdir=@abs_srcdir@
top_blddir=@abs_builddir@

# Create apu-config script suitable for the install tree
apreq2-config.out: $(APREQ_CONFIG)
	sed 's,^\(location=\).*$$,\1installed,' < $(APREQ_CONFIG) > $@

install: $(TARGET_LIB) apreq2-config.out
	$(APR_MKDIR) $(DESTDIR)$(includedir) $(DESTDIR)$(libdir)/pkgconfig \
		     $(DESTDIR)$(libdir) $(DESTDIR)$(bindir)
	for f in $(top_srcdir)/include/*.h $(top_blddir)/include/*.h; do \
		$(INSTALL_DATA) $${f} $(DESTDIR)$(includedir); \
	done
	echo $(INSTALL_DATA) apr-util.pc $(DESTDIR)$(libdir)/pkgconfig/$(APRUTIL_PCFILE)
	list='$(INSTALL_SUBDIRS)'; for i in $$list; do \
		( cd $$i ; $(MAKE) DESTDIR=$(DESTDIR) install ); \
	done
	$(LIBTOOL) --mode=install $(INSTALL) -m 755 $(TARGET_LIB) $(DESTDIR)$(libdir)
	$(INSTALL_DATA) apreq.exp $(DESTDIR)$(libdir)
	$(INSTALL) -m 755 apreq2-config.out $(DESTDIR)$(bindir)/$(APREQ_CONFIG)

$(TARGET_LIB): $(OBJECTS)
	$(LINK) @lib_target@ $(ALL_LIBS) $(APREQ_LDFLAGS) $(APREQ_LIBS)

exports.c: $(HEADERS)
	$(APR_MKEXPORT) $(HEADERS) > $@

export_vars.c: $(HEADERS)
	$(APR_MKVAREXPORT) $(HEADERS) > $@

apreq.exp: exports.c export_vars.c
	@echo "#! lib@APREQ_LIBNAME@.so" > $@
	@echo "* This file was AUTOGENERATED at build time." >> $@
	@echo "* Please do not edit by hand." >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) exports.c | grep "ap_hack_" | sed -e 's/^.*[)]\(.*\);$$/\1/' >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) export_vars.c | sed -e 's/^\#[^!]*//' | sed -e '/^$$/d' >> $@

dox:
	doxygen $(top_srcdir)/docs/doxygen.conf

test: check
check: $(TARGET_LIB)
	cd test && $(MAKE) check
